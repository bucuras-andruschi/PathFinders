#include <SPI.h>
#include <Pixy2.h> // Include the correct library for PixyCam 2
#include <Servo.h>

Pixy2 pixy;
Servo servoMotor;

int myPins[6] = {5, 6, 7, 8, 9, 10}; // ENA IN1 IN2 IN3 IN4 ENB
bool obstacleDetected = false;
int lastCubeColor = 0; // 1: Red, 2: Green

void setup() {
  Serial.begin(9600);
  Serial.println("Starting...");
  pixy.init();
  servoMotor.attach(4); // Attaching the servo motor to pin 4
  for (int i = 0; i < 6; i++) {
    pinMode(myPins[i], OUTPUT);
  }
  moveRobot(0, 0); // Ensure motors are stopped initially
}

void loop() {
  moveRobot(50, 50); // Move forward at a very low speed
  pixyCheck();
  
  if (obstacleDetected) {
    // Stop motors before turning servo
    moveRobot(0, 0);
    if (lastCubeColor == 1) { // Red cube
      // Turn right
      servoMotor.write(120); // Adjust servo position to turn right
      delay(500); // Wait for servo to move

      // Continue moving forward
      moveRobot(50, 50);
      delay(500); // Allow some time to move forward

      // Return to center
      moveRobot(0, 0); // Stop motors before turning servo
      servoMotor.write(90); // Return to center position
      delay(500); // Wait for servo to move
    } else if (lastCubeColor == 2) { // Green cube
      // Turn left
      servoMotor.write(45); // Adjust servo position to turn left
      delay(500); // Wait for servo to move

      // Continue moving forward
      moveRobot(50, 50);
      delay(500); // Allow some time to move forward



      // Return to center
      moveRobot(0, 0); // Stop motors before turning servo
      servoMotor.write(90); // Return to center position
      delay(500); // Wait for servo to move
    }
    
    obstacleDetected = false;
    lastCubeColor = 0; // Reset last cube color after avoiding the obstacle
  }

  delay(100); // Add a delay to allow the Pixy2 camera to detect objects
}

int pixyCheck() {
  int blocks = pixy.ccc.getBlocks();
  if (blocks) {
    int signature = pixy.ccc.blocks[0].m_signature;
    if (signature == 1 || signature == 2) { // Red or green cube
      obstacleDetected = true;
      lastCubeColor = signature;
      Serial.print("Detected color: ");
      Serial.println(signature == 1 ? "Red" : "Green");
      return signature;
    }
  }
  return 0; // Return 0 if no blocks detected or other color detected
}

void moveRobot(int leftSpeed, int rightSpeed) {
  if (leftSpeed >= 0) {
    digitalWrite(myPins[1], LOW);
    digitalWrite(myPins[2], HIGH);
  } else {
    digitalWrite(myPins[1], HIGH);
    digitalWrite(myPins[2], LOW);
  }

  if (rightSpeed >= 0) {
    digitalWrite(myPins[3], LOW);
    digitalWrite(myPins[4], HIGH);
  } else {
    digitalWrite(myPins[3], HIGH);
    digitalWrite(myPins[4], LOW);
  }

  analogWrite(myPins[0], abs(leftSpeed));
  analogWrite(myPins[5], abs(rightSpeed));
}
